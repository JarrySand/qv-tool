# QV-Tool é–‹ç™ºå¼•ãç¶™ãè³‡æ–™

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

**Quadratic Voting Tool (QV-Tool)** ã¯ã€äºŒæ¬¡æŠ•ç¥¨ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã‚’ç”¨ã„ãŸæ°‘ä¸»çš„ãªæ„æ€æ±ºå®šãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚

### ç¾åœ¨ã®çŠ¶æ…‹

- **Phase 1: åŸºç›¤æ§‹ç¯‰** âœ… å®Œäº†
- **Phase 2: èªè¨¼ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†** âœ… å®Œäº†
- **Phase 3: æŠ•ç¥¨æ©Ÿèƒ½** ğŸ”² æœªç€æ‰‹
- **Phase 4: é›†è¨ˆãƒ»çµæœè¡¨ç¤º** ğŸ”² æœªç€æ‰‹
- **Phase 5: å“è³ªå‘ä¸Šãƒ»æœ€é©åŒ–** ğŸ”² æœªç€æ‰‹

---

## 2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ã‚«ãƒ†ã‚´ãƒª   | æŠ€è¡“                     | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
| ---------- | ------------------------ | ---------- |
| Framework  | Next.js (App Router)     | 16.0.4     |
| Language   | TypeScript               | ^5         |
| Styling    | Tailwind CSS + Shadcn/ui | v4         |
| Database   | PostgreSQL               | 16-alpine  |
| ORM        | Prisma                   | 7.0.1      |
| Validation | Zod                      | ^4.1.13    |
| Auth       | NextAuth.js (v5)         | 5.0.0-beta |
| Test       | Vitest + Playwright      | å°å…¥æ¸ˆã¿   |

---

## 3. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
qv-tool/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma          # DBã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â””â”€â”€ migrations/            # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚   â”‚       â”œâ”€â”€ signin/    # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ â­
â”‚   â”‚   â”‚       â””â”€â”€ error/     # èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ â­
â”‚   â”‚   â”œâ”€â”€ (dashboard)/
â”‚   â”‚   â”‚   â””â”€â”€ admin/
â”‚   â”‚   â”‚       â”œâ”€â”€ create/    # ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒšãƒ¼ã‚¸ â­
â”‚   â”‚   â”‚       â”œâ”€â”€ created/   # ä½œæˆå®Œäº†ãƒšãƒ¼ã‚¸ â­
â”‚   â”‚   â”‚       â””â”€â”€ [id]/      # ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸ â­
â”‚   â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â”œâ”€â”€ vote/      # æŠ•ç¥¨ç”»é¢ï¼ˆPhase 3ã§å®Ÿè£…ï¼‰
â”‚   â”‚   â”‚       â””â”€â”€ result/    # çµæœç”»é¢ï¼ˆPhase 4ã§å®Ÿè£…ï¼‰
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚   â”‚       â””â”€â”€ [...nextauth]/ # NextAuth API â­
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â””â”€â”€ page.tsx           # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆåˆ·æ–°æ¸ˆã¿ï¼‰
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/                # Shadcn/ui ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ features/          # æ©Ÿèƒ½ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ event-create-form.tsx     â­
â”‚   â”‚   â”‚   â”œâ”€â”€ event-created-content.tsx â­
â”‚   â”‚   â”‚   â”œâ”€â”€ event-admin-content.tsx   â­
â”‚   â”‚   â”‚   â”œâ”€â”€ event-edit-dialog.tsx     â­
â”‚   â”‚   â”‚   â”œâ”€â”€ subject-list.tsx          â­
â”‚   â”‚   â”‚   â””â”€â”€ access-token-manager.tsx  â­
â”‚   â”‚   â””â”€â”€ layout/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ actions/
â”‚   â”‚   â”‚   â”œâ”€â”€ event.ts       # ã‚¤ãƒ™ãƒ³ãƒˆServer Actions â­
â”‚   â”‚   â”‚   â”œâ”€â”€ subject.ts     # æŠ•ç¥¨å¯¾è±¡Server Actions â­
â”‚   â”‚   â”‚   â””â”€â”€ access-token.ts # ãƒˆãƒ¼ã‚¯ãƒ³Server Actions â­
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ line-provider.ts   # LINE OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ â­
â”‚   â”‚   â”‚   â””â”€â”€ voting-auth.ts     # æŠ•ç¥¨è€…èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ â­
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â”œâ”€â”€ qv.ts          # QVè¨ˆç®—
â”‚   â”‚   â”‚   â”œâ”€â”€ qv.test.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ slug.ts        # ã‚¹ãƒ©ãƒƒã‚°ç”Ÿæˆ â­
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ utils.ts
â”‚   â”‚   â””â”€â”€ validations/
â”‚   â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ next-auth.d.ts     # NextAuthå‹æ‹¡å¼µ â­
â”‚   â”œâ”€â”€ auth.ts                # NextAuthè¨­å®š â­
â”‚   â””â”€â”€ middleware.ts          # ãƒ«ãƒ¼ãƒˆä¿è­·ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ â­
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ development-plan.md
â””â”€â”€ system-specification.md
```

---

## 4. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# 1. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# 2. ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.example .env
# .env ã‚’ç·¨é›†

# 3. DBã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
docker-compose up -d

# 4. Prisma Clientç”Ÿæˆ & ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
npx prisma generate
npx prisma migrate dev

# 5. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
```

### ä¸»è¦ã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰             | èª¬æ˜                 |
| -------------------- | -------------------- |
| `npm run dev`        | é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•     |
| `npm run build`      | ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ |
| `npm run lint`       | ESLintå®Ÿè¡Œ           |
| `npm run format`     | Prettierå®Ÿè¡Œ         |
| `npm run type-check` | TypeScriptãƒã‚§ãƒƒã‚¯   |
| `npm run test`       | å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ       |
| `npm run test:e2e`   | E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ        |
| `npm run db:studio`  | Prisma Studioèµ·å‹•    |
| `npm run db:migrate` | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ |

---

## 5. Phase 2 å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

### 5.1 èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 

**NextAuth.js v5 (Auth.js)**

- JWTã‚»ãƒƒã‚·ãƒ§ãƒ³æˆ¦ç•¥
- PrismaAdapterã«ã‚ˆã‚‹DBé€£æº
- ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ãƒ³ã‚¤ãƒ³/ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸

**Google OAuth**

- ç’°å¢ƒå¤‰æ•°: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: `src/auth.ts`

**LINE OpenID Connect**

- ç’°å¢ƒå¤‰æ•°: `LINE_CHANNEL_ID`, `LINE_CHANNEL_SECRET`
- ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: `src/lib/auth/line-provider.ts`

**å€‹åˆ¥æŠ•ç¥¨èªè¨¼**

- AccessTokenãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
- èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼: `src/lib/auth/voting-auth.ts`
  - `authenticateVoter()`: æŠ•ç¥¨è€…èªè¨¼
  - `checkVoteStatus()`: æŠ•ç¥¨çŠ¶æ³ç¢ºèª
  - `getEventAuthRequirement()`: ã‚¤ãƒ™ãƒ³ãƒˆèªè¨¼è¦ä»¶å–å¾—

### 5.2 ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†æ©Ÿèƒ½

**ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ**

- ãƒ•ã‚©ãƒ¼ãƒ UI: `src/components/features/event-create-form.tsx`
- Server Action: `src/lib/actions/event.ts`
  - adminTokenè‡ªå‹•ç”Ÿæˆ
  - slugè‡ªå‹•/æ‰‹å‹•ç”Ÿæˆ

**ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ãƒšãƒ¼ã‚¸**

- URL: `/admin/[id]?token=<adminToken>`
- æ©Ÿèƒ½:
  - ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±è¡¨ç¤ºãƒ»ç·¨é›†
  - æŠ•ç¥¨å¯¾è±¡ï¼ˆSubjectï¼‰ã®CRUD
  - å€‹åˆ¥æŠ•ç¥¨ãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆãƒ»CSVå‡ºåŠ›
  - æŠ•ç¥¨é–‹å§‹å¾Œã®ç·¨é›†åˆ¶é™

### 5.3 æŠ•ç¥¨å¯¾è±¡ç®¡ç†

- Subjectä½œæˆãƒ»ç·¨é›†ãƒ»å‰Šé™¤
- ç”»åƒURLå¯¾å¿œï¼ˆå¤–éƒ¨URLï¼‰
- è¡¨ç¤ºé †åºç®¡ç†ï¼ˆorderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰

### 5.4 å€‹åˆ¥æŠ•ç¥¨ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†

- ãƒˆãƒ¼ã‚¯ãƒ³ä¸€æ‹¬ç”Ÿæˆï¼ˆ1ã€œ100ä»¶ï¼‰
- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- ä½¿ç”¨çŠ¶æ³ã®è¡¨ç¤º

---

## 6. Phase 3 ã§å®Ÿè£…ã™ã¹ãå†…å®¹

### 3.1 ã‚¤ãƒ™ãƒ³ãƒˆå…¬é–‹ãƒšãƒ¼ã‚¸

- [ ] ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
- [ ] ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜ã€æœŸé–“ï¼‰
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆé–‹å‚¬ä¸­/çµ‚äº†ï¼‰
- [ ] èªè¨¼çŠ¶æ…‹ã«å¿œã˜ãŸãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

### 3.2 QVè¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

- [x] ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ¶ˆè²»è¨ˆç®—é–¢æ•°ï¼ˆç¥¨æ•°Â² = ã‚³ã‚¹ãƒˆï¼‰
- [x] æ®‹ã‚Šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¨ˆç®—é–¢æ•°
- [x] æŠ•ç¥¨å¯èƒ½ç¥¨æ•°ã®ä¸Šé™è¨ˆç®—é–¢æ•°
- [x] ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®å˜ä½“ãƒ†ã‚¹ãƒˆ

### 3.3 æŠ•ç¥¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

- [ ] æŠ•ç¥¨å¯¾è±¡ä¸€è¦§ã®è¡¨ç¤º
- [ ] ã€Œ+ã€ã€Œ-ã€ãƒœã‚¿ãƒ³ã®å®Ÿè£…
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¨ˆç®—
- [ ] æ®‹ã‚Šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨ç¤º
- [ ] æŠ•ç¥¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½

### 3.4 ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

- [ ] ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] äºŒé‡æŠ•ç¥¨ã®é˜²æ­¢

### 3.5 æŠ•ç¥¨é€ä¿¡å‡¦ç†

- [ ] Server Actionå®Ÿè£…
- [ ] ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
- [ ] æŠ•ç¥¨å®Œäº†ç”»é¢

### 3.6 å†æŠ•ç¥¨æ©Ÿèƒ½

- [ ] æŠ•ç¥¨å†…å®¹ã®ç·¨é›†æ©Ÿèƒ½
- [ ] æ—¢å­˜æŠ•ç¥¨ã®æ›´æ–°å‡¦ç†

---

## 7. æŠ€è¡“çš„æ³¨æ„ç‚¹

### 7.1 èªè¨¼è¨­è¨ˆ

- **ä¸»å‚¬è€…**: èªè¨¼ä¸è¦ã€‚`Event.adminToken` ã§ã‚¤ãƒ™ãƒ³ãƒˆç·¨é›†æ¨©é™ã‚’åˆ¶å¾¡
- **æŠ•ç¥¨è€…ï¼ˆå€‹åˆ¥ï¼‰**: `AccessToken` ä»˜ãURLã§ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰
- **æŠ•ç¥¨è€…ï¼ˆSocialï¼‰**: NextAuth.jsã«ã‚ˆã‚‹OAuthèªè¨¼ï¼ˆGoogle/LINEï¼‰

### 7.2 æŠ•ç¥¨èªè¨¼ãƒ•ãƒ­ãƒ¼

```typescript
// src/lib/auth/voting-auth.ts ã‚’ä½¿ç”¨
const authResult = await authenticateVoter(eventId, token);
if (!authResult.authenticated) {
  // ã‚¨ãƒ©ãƒ¼å‡¦ç†
}
if (authResult.type === "token") {
  // å€‹åˆ¥æŠ•ç¥¨ãƒ¢ãƒ¼ãƒ‰
} else {
  // Socialèªè¨¼ãƒ¢ãƒ¼ãƒ‰
}
```

### 7.3 ç’°å¢ƒå¤‰æ•°ï¼ˆèªè¨¼é–¢é€£ï¼‰

```env
# .env.example å‚ç…§
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key"
GOOGLE_CLIENT_ID=""
GOOGLE_CLIENT_SECRET=""
LINE_CHANNEL_ID=""
LINE_CHANNEL_SECRET=""
```

### 7.4 è¨­è¨ˆæ±ºå®šäº‹é …

1. ä¸»å‚¬è€…èªè¨¼: ãªã—ï¼ˆèª°ã§ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆå¯èƒ½ï¼‰
2. å†æŠ•ç¥¨: æŠ•ç¥¨æœŸé–“å†…ã¯ä½•åº¦ã§ã‚‚å¤‰æ›´å¯èƒ½ï¼ˆå¿…é ˆï¼‰
3. ãƒã‚¤ãƒŠã‚¹æŠ•ç¥¨: ãªã—ï¼ˆ0ä»¥ä¸Šã®ã¿ï¼‰
4. çµæœå…¬é–‹: å¸¸æ™‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¬é–‹

---

## 8. å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ«                  | å†…å®¹                                 |
| ------------------------- | ------------------------------------ |
| `development-plan.md`     | é–‹ç™ºè¨ˆç”»æ›¸ï¼ˆPhaseåˆ¥ã‚¿ã‚¹ã‚¯ä¸€è¦§ï¼‰      |
| `system-specification.md` | è¦ä»¶å®šç¾©æ›¸ï¼ˆæ©Ÿèƒ½è¦ä»¶ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼‰ |
| `README.md`               | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ãƒ»ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †   |

---

**ä½œæˆæ—¥**: 2025å¹´11æœˆ26æ—¥  
**Phase 1 å®Œäº†æ—¥**: 2025å¹´11æœˆ26æ—¥  
**Phase 2 å®Œäº†æ—¥**: 2025å¹´11æœˆ26æ—¥
