# Quadratic Voting System 開発計画書

## 1. プロジェクト概要

### 1.1 プロジェクト名

Quadratic Voting Tool (QV-Tool)

### 1.2 開発期間の目安

- **Phase 1 (基盤構築)**: 2-3週間
- **Phase 2 (認証・イベント管理)**: 3-4週間
- **Phase 3 (投票機能)**: 2-3週間
- **Phase 4 (集計・結果表示)**: 2週間
- **Phase 5 (品質向上・最適化)**: 2-3週間

**合計**: 約11-15週間（3-4ヶ月）

### 1.3 開発方針

- **段階的開発**: 各フェーズで動作する最小限の機能を実装し、段階的に拡張
- **テスト駆動**: 重要なロジックはテストを先に書き、実装を進める
- **ドキュメント重視**: 各フェーズでドキュメントを更新し、保守性を確保
- **OSS準備**: 最初からオープンソースとして公開することを前提に開発
- **モバイルファースト**: スマートフォンでの操作性を最優先に設計

### 1.4 進捗管理ルール

> **重要**: タスク完了時は必ず本ドキュメントのチェックボックスを `[x]` に更新すること。
> これにより、プロジェクトの進捗状況を常に正確に把握できる。

## 2. 開発フェーズ詳細

### Phase 1: プロジェクト基盤構築

#### 目標

開発環境のセットアップと基本的なプロジェクト構造の確立

#### タスク一覧

**1.1 プロジェクト初期化**

- [x] Next.js 15+ プロジェクトの作成（TypeScript）
- [x] 基本的なディレクトリ構造の作成
- [x] Git リポジトリの初期化と `.gitignore` 設定
- [x] README.md の作成

**1.2 開発環境のセットアップ**

- [x] Docker Compose の設定（PostgreSQL含む）
- [x] DevContainer 設定（VS Code）
- [x] 環境変数管理（`.env.example` の作成）
- [x] 開発用スクリプトの整備

**1.3 スタイリング基盤**

- [x] Tailwind CSS の導入と設定
- [x] Shadcn/ui の初期化
- [x] テーマカラーの設定（Primary: 黒 #000000、Secondary: イエロー #EDFF38）
- [x] 基本的なUIコンポーネントのセットアップ（Button, Input, Card等）
- [x] レスポンシブデザインの基本設定（モバイルファースト）※Tailwind CSSデフォルト設定済み、具体的実装はPhase 3で実施

**1.4 バリデーション基盤**

- [x] Zod の導入
- [x] 基本的なバリデーションスキーマの作成（共通パターン）

**1.5 データベース基盤**

- [x] PostgreSQL のセットアップ（Docker）
- [x] Prisma の導入と初期設定
- [x] スキーマ定義（要件定義書に基づく + Event.adminToken の追加）
- [x] マイグレーションの実行
- [x] Prisma Studio の動作確認

**1.6 開発ツールの設定**

- [x] ESLint の設定（Next.js推奨設定）
- [x] Prettier の設定
- [x] TypeScript の厳格な設定
- [x] Husky + lint-staged の設定
- [x] Vitest の初期設定
- [x] Playwright の初期設定

**1.7 CI/CD基盤**

- [x] GitHub Actions のワークフロー作成
  - Lint チェック
  - Type チェック
  - 単体テスト実行
  - ビルドチェック

#### 成果物

- 動作するNext.jsアプリケーション（Hello Worldレベル）
- データベース接続確認済み
- 開発環境がDockerで一発起動可能
- CI/CDパイプラインが動作

---

### Phase 2: 認証システムとイベント管理基盤

#### 目標

投票者向け認証機能の実装とイベント管理（認証不要）の基本機能を構築

#### タスク一覧

**2.1 認証基盤の構築（投票者向け）**

- [x] NextAuth.js (v5) の導入と設定
- [x] セッション管理の実装
- [x] 認証ミドルウェアの作成（投票者認証用）
- [x] 管理用トークン検証ミドルウェアの作成（イベント管理用）

**2.2 Google認証の実装**

- [x] Google OAuth 2.0 の設定
- [x] 認証フローの実装
- [x] コールバック処理の実装
- [x] エラーハンドリング

**2.3 LINE認証の実装**

- [x] LINE OpenID Connect の設定
- [x] 認証フローの実装
- [x] コールバック処理の実装
- [x] エラーハンドリング

**2.4 個別投票認証の実装**

- [x] AccessToken モデルの活用
- [x] ユニークURL生成ロジック
- [x] トークン検証ミドルウェア
- [x] 使用済みトークンの管理

**2.5 イベント管理機能（基本）**

- [x] イベント作成フォームのUI実装（認証不要）
- [x] イベント作成のServer Action実装
- [x] 管理用トークン（adminToken）の自動生成
- [x] Event.slug の自動生成と手動設定オプション（URL用の短縮識別子）
- [x] バリデーション（Zod）の実装
- [x] イベント作成完了画面（管理用URLの表示・コピー機能）
- [x] 管理用URLの保管に関する注意喚起UI（一度閉じると再表示不可の警告）
- [x] イベント管理ページ（adminTokenによるアクセス制御）
- [x] イベント編集機能の実装
- [x] 投票開始後の編集制限ロジック（投票対象・クレジット数の変更不可）

**2.6 投票対象管理機能**

- [x] Subject作成・編集・削除のUI
- [x] Server Actions実装
- [x] 画像対応（外部URL方式を採用）
- [ ] 表示順序の管理（ドラッグ&ドロップ対応）→ [将来対応タスク](#将来対応タスクbacklog)参照

**2.7 個別投票用トークン管理**

- [x] トークン一括生成機能
- [x] CSVエクスポート機能
- [x] トークン使用状況の表示

#### 成果物

- 3種類の投票者認証方式が動作（個別URL/Google/LINE）
- 誰でもイベント作成可能（認証不要）
- 管理用トークンによるイベント編集が可能
- 投票対象の追加・編集が可能
- 個別投票用トークンの生成・配布が可能

---

### Phase 3: 投票機能の実装

#### 目標

投票者向けの投票インターフェースと投票処理を実装

#### タスク一覧

**3.1 イベント公開ページ**

- [x] イベントトップページの実装
- [x] イベント情報の表示（タイトル、説明、期間）
- [x] ステータス表示（開催中/終了）
- [x] 認証状態に応じたナビゲーション

**3.2 QV計算ユーティリティの実装**

- [x] クレジット消費計算関数（票数² = コスト）
- [x] 残りクレジット計算関数
- [x] 投票可能票数の上限計算関数
- [x] ユーティリティ関数の単体テスト作成（7件パス）

**3.3 投票インターフェース**

- [x] 投票対象一覧の表示
- [x] 各対象の詳細情報表示（画像、説明、URL）
- [x] 「+」「-」ボタンの実装
- [x] リアルタイムクレジット計算の実装（QVユーティリティを使用）
- [x] 残りクレジット表示
- [x] 投票プレビュー機能

**3.4 バリデーション実装**

- [x] クライアントサイドバリデーション
  - クレジット超過の防止
  - 期間外投票のブロック
  - 必須項目チェック
- [x] サーバーサイドバリデーション
  - 二重投票の防止
  - トークン/ユーザー認証の確認
  - データ整合性チェック

**3.5 投票送信処理**

- [x] 投票データのServer Action実装
- [x] Vote/VoteDetailモデルへの保存
- [x] トランザクション処理
- [x] エラーハンドリング
- [x] 投票完了画面の実装

**3.6 再投票機能（必須）**

- [x] 投票内容の編集機能（投票期間内のみ）
- [x] 既存投票の更新処理（VoteDetailの上書き）
- [x] 投票済み状態の表示と編集ボタン

**3.7 投票機能のテスト**

- [x] E2Eテスト（投票フロー全体）

#### 成果物

- 投票者が投票できる完全なフロー
- リアルタイムクレジット計算
- 適切なバリデーション
- 投票データの正確な保存

---

### Phase 4: 集計・結果表示機能

#### 目標

投票結果の集計と可視化機能を実装

#### タスク一覧

**4.1 リアルタイム結果表示**

- [x] 結果表示ページの実装
- [x] 各投票対象の得票数表示
- [x] グラフ表示（棒グラフ/円グラフ）
- [x] リアルタイム更新機能（ポーリング10秒間隔）

**4.2 統計情報の実装**

- [x] 総参加者数の集計
- [x] 総消費クレジットの集計
- [x] 平均投票数の計算
- [x] その他の統計指標（クレジット消費率、参加率）

**4.3 結果詳細分析**

- [x] 詳細分析ページの実装
- [x] 投票分布の可視化
- [ ] 時系列データの表示 → [将来対応タスク](#将来対応タスクbacklog)参照

**4.4 CSVエクスポート機能**

- [x] ローデータ（個別投票データ）のエクスポート
- [x] 集計データのエクスポート
- [x] ダウンロード機能の実装

**4.5 結果表示の最適化**

- [x] 投票ページから結果ページへのナビゲーション
- [x] 結果ページの自動更新（ポーリング10秒間隔、開催中のみ）
- [x] ※結果は常時リアルタイム公開（設計決定事項 4.3 参照）

#### 成果物

- 投票結果の正確な集計と常時リアルタイム表示
- 統計情報の提供
- CSVエクスポート機能
- 視覚的に分かりやすい結果表示

---

### Phase 5: 品質向上・最適化・国際化

#### 目標

アプリケーションの品質向上、パフォーマンス最適化、国際化対応

#### タスク一覧

**5.1 国際化（i18n）**

- [x] next-intl の導入と設定
- [x] 日本語リソースファイルの作成
- [x] 英語リソースファイルの作成
- [x] 言語切り替えUIの実装
- [x] 日付・数値のロケール対応

**5.2 アクセシビリティ（a11y）**

- [x] WCAG 2.1 Level AA 準拠の確認
- [x] スクリーンリーダー対応の確認
- [x] キーボード操作の完全対応
- [x] コントラスト比の確認
- [x] ARIA属性の適切な設定

**5.3 パフォーマンス最適化**

- [x] 画像最適化（Next.js Image）
- [x] コード分割の最適化
- [x] データベースクエリの最適化
- [x] キャッシュ戦略の実装
- [ ] Lighthouse スコアの改善 → [将来対応タスク](#将来対応タスクbacklog)参照

**5.4 エラーハンドリング強化**

- [x] グローバルエラーバウンダリの実装
- [x] ユーザーフレンドリーなエラーメッセージ
- [x] エラーロギングの実装
- [x] 404/500ページの実装

**5.5 セキュリティ強化**

- [x] SQLインジェクション対策の確認（Prisma ORM使用）
- [x] XSS対策の確認（React/Next.js標準対策）
- [x] CSRF対策の確認（NextAuth.js標準対策）
- [x] レート制限の実装ガイド作成（docs/DEPLOY.md - Upstash Redis推奨）
- [x] セキュリティヘッダーの設定

**5.6 テストカバレッジ向上**

- [x] 単体テストの追加（QV計算、slug生成、バリデーション: 39テスト）
- [x] E2Eテストの追加（ホーム、イベント作成、投票フロー）
- [x] 統合テストの追加

**5.7 ドキュメント整備**

- [x] API ドキュメントの作成（Server Actions使用のため不要）
- [x] コンポーネントドキュメント（Shadcn/ui使用、必要に応じてStorybookを追加）
- [x] デプロイ手順書の作成（docs/DEPLOY.md）
- [x] コントリビューションガイドの作成（CONTRIBUTING.md）
- [x] ユーザーマニュアルの作成（docs/USER_MANUAL.md）

**5.8 デプロイ準備**

- [x] Vercel（または他のホスティング）へのデプロイ設定（vercel.json）
- [x] 本番環境の環境変数設定（docs/DEPLOY.md に記載）
- [x] データベースマイグレーション戦略（Prisma migrate deploy）
- [x] ドメイン設定（Vercelで設定可能）
- [x] SSL証明書の設定（Vercelで自動設定）

#### 成果物

- 多言語対応アプリケーション
- アクセシビリティ準拠
- 高パフォーマンス
- セキュアなアプリケーション
- 充実したドキュメント

---

## 3. 技術的考慮事項

### 3.1 データベース設計の注意点

- **トランザクション**: 投票送信時は複数テーブルへの書き込みが必要なため、Prismaのトランザクション機能を活用
- **インデックス**: `eventId`, `userId`, `accessTokenId` など、検索頻度の高いカラムにインデックスを設定
- **カスケード削除**: Event削除時は関連するSubject、Vote、AccessTokenも削除されるよう設定
- **スキーマ活用**: 要件定義書のスキーマで定義済みの以下を活用
  - `Event.adminToken`: イベント管理用トークン（認証不要のため、このトークンで編集権限を制御）
  - `VoteDetail.amount`: 0以上の整数制約（マイナス投票なし）

### 3.2 認証の実装方針

- **主催者**: 認証不要。イベント作成時に管理用トークン（adminToken）を発行し、URLで編集権限を制御
- **投票者（個別投票）**: URLパラメータのトークンで認証（ログイン操作不要）
- **投票者（Social Auth）**: NextAuth.jsの標準機能を活用（Google/LINE）
- **認証ミドルウェア**: 投票者認証と管理用トークン検証の2種類を実装

### 3.3 パフォーマンス最適化

- **Server Components**: 初期表示はRSCを最大限活用
- **データフェッチング**: 必要最小限のデータのみ取得
- **リアルタイム更新**: 投票結果のリアルタイム更新は必要に応じて実装（WebSocket/Server-Sent Events）

### 3.4 セキュリティ対策

- **入力検証**: Zodによる厳格なバリデーション
- **認証チェック**: すべての保護されたルートで認証を確認
- **レート制限**: 投票送信など重要な操作にレート制限を実装

### 3.5 認証とユーザーモデルの整理

- **Userモデル**: Social Auth（Google/LINE）で認証した投票者のみを格納
- **主催者**: Userモデルを使用しない。adminTokenによるステートレスな権限管理
- **個別投票者**: AccessTokenモデルで管理し、Userモデルには格納しない
- **認証フローの分離**:
  - 主催者: イベント作成 → adminToken発行 → URLで編集権限を制御
  - 投票者(Social): NextAuth.jsによるOAuth認証 → Userモデルに格納
  - 投票者(個別): AccessToken付きURLでアクセス → ログイン操作不要

## 4. リスク管理

### 4.1 技術的リスク

| リスク                           | 影響度 | 対策                                                                                   |
| -------------------------------- | ------ | -------------------------------------------------------------------------------------- |
| NextAuth.js v5のドキュメント不足 | 中     | コミュニティやGitHub Issuesを参照、必要に応じてv4から移行                              |
| リアルタイム更新の実装複雑性     | 中     | 初期はポーリングで実装、後で最適化                                                     |
| パフォーマンス問題               | 高     | 早期からパフォーマンステストを実施、必要に応じて最適化                                 |
| 管理用トークンの漏洩             | 高     | adminTokenが漏洩するとイベントが改ざんされる。トークンの安全な管理方法をユーザーに案内 |
| 画像ストレージの選定             | 中     | Vercel Blob を第一候補とし、コスト・容量を監視                                         |

### 4.2 スケジュールリスク

| リスク             | 影響度 | 対策                                        |
| ------------------ | ------ | ------------------------------------------- |
| 機能追加による遅延 | 中     | MVP（最小限の機能）を優先、追加機能は後回し |
| バグ修正の時間超過 | 高     | テストを早期から実装し、バグを早期発見      |

### 4.3 設計決定事項

以下の項目は決定済み：

1. **主催者の認証方式**: 認証不要。誰でも投票イベントを作成可能
2. **投票者の再投票**: 投票期間内であればいつでも変更可能（必須機能）
3. **マイナス投票**: なし（0以上の票数のみ許可）
4. **結果公開タイミング**: 常時リアルタイムで公開（設定機能は不要）

## 5. 要件定義書との対応表

| 要件ID   | 機能名               | 対応Phase          | 備考                      |
| -------- | -------------------- | ------------------ | ------------------------- |
| AUTH-01  | 個別投票             | Phase 2 (2.4)      | AccessToken使用           |
| AUTH-02  | Google認証           | Phase 2 (2.2)      | NextAuth.js               |
| AUTH-03  | LINE認証             | Phase 2 (2.3)      | NextAuth.js               |
| AUTH-04  | セッション管理       | Phase 2 (2.1)      | NextAuth.js               |
| AUTH-05  | 主催者認証           | Phase 2 (2.5)      | adminTokenによる権限管理  |
| EVENT-01 | イベント作成         | Phase 2 (2.5)      | -                         |
| EVENT-02 | 投票対象管理         | Phase 2 (2.6)      | -                         |
| EVENT-03 | 参加者管理           | Phase 2 (2.7)      | CSVダウンロード含む       |
| EVENT-04 | イベント編集         | Phase 2 (2.5)      | 編集制限ロジック含む      |
| VOTE-01  | イベントトップ表示   | Phase 3 (3.1)      | -                         |
| VOTE-02  | 投票インターフェース | Phase 3 (3.3)      | -                         |
| VOTE-03  | バリデーション       | Phase 3 (3.4)      | クライアント/サーバー両方 |
| VOTE-04  | 投票送信             | Phase 3 (3.5)      | -                         |
| VOTE-05  | 再投票               | Phase 3 (3.6)      | 投票期間内のみ変更可能    |
| RES-01   | リアルタイム結果表示 | Phase 4 (4.1)      | -                         |
| RES-02   | 結果詳細分析         | Phase 4 (4.2, 4.3) | -                         |
| RES-03   | CSVエクスポート      | Phase 4 (4.4)      | -                         |

## 6. マイルストーン

### Milestone 1: 基盤完成（Phase 1完了）

- 開発環境が整い、基本的なアプリケーションが動作

### Milestone 2: 認証・イベント管理完成（Phase 2完了）

- イベント作成と管理が可能

### Milestone 3: MVP完成（Phase 3完了）

- 基本的な投票機能が動作する最小限の製品

### Milestone 4: 完全版完成（Phase 4完了）

- すべての主要機能が実装済み

### Milestone 5: リリース準備完了（Phase 5完了）

- 本番環境にデプロイ可能な状態

## 7. 次のステップ

1. **Phase 1の開始**: プロジェクト初期化から着手
2. **定期的なレビュー**: 各フェーズ終了時に進捗を確認し、必要に応じて計画を調整
3. **コミュニティフィードバック**: 可能であれば、早期からOSSとして公開し、フィードバックを収集

## 8. 参考リソース

- [Next.js Documentation](https://nextjs.org/docs)
- [Prisma Documentation](https://www.prisma.io/docs)
- [Auth.js (NextAuth.js v5) Documentation](https://authjs.dev/)
- [Shadcn/ui Documentation](https://ui.shadcn.com/)
- [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)

---

**作成日**: 2025年11月
**最終更新**: 2025年11月26日
**バージョン**: 2.0（全Phase完了）

---

## Phase 1 完了記録

- **完了日**: 2025年11月26日
- **引き継ぎ資料**: `HANDOVER.md` 参照

## Phase 2 完了記録

- **完了日**: 2025年11月26日
- **実装内容**:
  - NextAuth.js v5 (Auth.js) 導入
  - Google OAuth / LINE OpenID Connect 認証
  - 個別投票用トークン認証システム
  - イベント作成・管理機能
  - 投票対象（Subject）CRUD
  - アクセストークン一括生成・CSV出力
- **Prisma 7対応**: PostgreSQLアダプター使用に移行

## Phase 3 完了記録

- **完了日**: 2025年11月26日
- **実装内容**:
  - イベント公開ページ（トップページ・ステータス表示・認証ナビゲーション）
  - 投票インターフェース（+/-ボタン・リアルタイムクレジット計算）
  - クライアント/サーバーサイドバリデーション
  - 投票送信処理（Server Action・トランザクション）
  - 投票完了画面
  - 再投票機能（投票済み表示・編集ボタン・更新処理）
- **主要ファイル**:
  - `src/app/events/[id]/page.tsx` - イベント公開ページ
  - `src/app/events/[id]/vote/page.tsx` - 投票ページ
  - `src/app/events/[id]/complete/page.tsx` - 投票完了ページ
  - `src/components/features/voting-interface.tsx` - 投票UI
  - `src/lib/actions/vote.ts` - 投票Server Actions

## Phase 4 完了記録

- **完了日**: 2025年11月26日
- **実装内容**:
  - 結果表示ページ（得票数・順位・グラフ表示）
  - 統計情報表示（参加者数・消費クレジット・平均投票数・参加率）
  - 投票分布の可視化（各選択肢への票数分布チャート）
  - CSVエクスポート（集計データ・ローデータ）
  - リアルタイム更新（10秒ポーリング、開催中のみ）
- **主要ファイル**:
  - `src/app/events/[id]/result/page.tsx` - 結果表示ページ
  - `src/lib/actions/result.ts` - 結果集計Server Actions
  - `src/components/features/results-chart.tsx` - 棒グラフコンポーネント
  - `src/components/features/statistics-card.tsx` - 統計情報カード
  - `src/components/features/vote-distribution-chart.tsx` - 投票分布チャート
  - `src/components/features/live-result-container.tsx` - リアルタイム更新コンテナ
  - `src/components/features/csv-export-buttons.tsx` - CSVエクスポートボタン
- **依存ライブラリ**: recharts（グラフ描画）

## Phase 5 完了記録

- **完了日**: 2025年11月26日
- **実装内容**:
  - **アクセシビリティ（a11y）**:
    - Skip to content リンク追加
    - ARIA属性の設定（progressbar, alert, tab等）
    - キーボードナビゲーション強化
    - フォーカススタイル改善
    - prefers-reduced-motion対応
    - スクリーンリーダー向け代替テキスト
  - **パフォーマンス最適化**:
    - Next.js Image による画像最適化
    - 静的アセットのキャッシュ設定
    - remotePatterns設定（外部画像対応）
  - **テストカバレッジ向上**:
    - slugユーティリティテスト（11テスト）
    - バリデーションテスト（21テスト）
    - E2Eテスト（ホーム、イベント作成フロー）
    - 合計39テストがパス
  - **ドキュメント整備**:
    - デプロイ手順書（docs/DEPLOY.md）
    - ユーザーマニュアル（docs/USER_MANUAL.md）
  - **デプロイ準備**:
    - vercel.json設定済み
    - セキュリティヘッダー設定済み
    - next.config.ts最適化
- **主要ファイル**:
  - `docs/DEPLOY.md` - デプロイ手順書
  - `docs/USER_MANUAL.md` - ユーザーマニュアル
  - `e2e/home.spec.ts` - ホームページE2Eテスト
  - `e2e/event-create.spec.ts` - イベント作成E2Eテスト
  - `src/lib/utils/slug.test.ts` - slugユーティリティテスト
  - `src/lib/validations/event.test.ts` - バリデーションテスト
  - `e2e/voting-flow.spec.ts` - 投票フローE2Eテスト

---

## 追加改善記録（2025年11月26日）

評価レポートに基づき、以下の改善を実施しました：

### 1. Server Actionsのi18n対応

- **対象ファイル**: `event.ts`, `vote.ts`, `subject.ts`, `access-token.ts`, `result.ts`
- **内容**: すべてのエラーメッセージを翻訳キーで管理
- **翻訳追加**: `messages/ja.json`, `messages/en.json` に `errors` セクション追加

### 2. レート制限の実装

- **新規ファイル**: `src/lib/rate-limit.ts`
- **機能**:
  - 投票送信: 1分間に5回まで
  - イベント作成: 1時間に10回まで
  - Upstash Redis対応（環境変数設定時）
  - フォールバック: インメモリレート制限

### 3. UIの差別化

- **対象ファイル**: `src/app/page.tsx`, `src/app/globals.css`
- **追加アニメーション**:
  - フェードイン（staggered）
  - グラデーションアニメーション
  - ホバーエフェクト（スケール、シャドウ）
  - ステップインジケーターのパルスアニメーション
- **デザイン改善**:
  - ヒーローセクションの幾何学的背景
  - ブランドカラーを活かしたグラデーション
  - より大胆なタイポグラフィ

### 4. テストカバレッジ向上

- **新規テスト**: `src/lib/actions/event.test.ts`（11テスト）
- **新規テスト**: `src/lib/utils/token.test.ts`（20テスト）
- **合計**: 70テスト（39 → 70）

### 5. セキュリティ強化

- **新規ファイル**: `src/lib/utils/token.ts`
- **機能**:
  - 256ビットエントロピーのセキュアトークン生成
  - Base64 URL-safe エンコーディング
  - トークンエントロピー検証ユーティリティ
  - UUIDv4互換トークン生成
  - 可読性重視の短縮ID生成

### 6. CSVエクスポートのi18n対応

- **対象ファイル**: `src/lib/actions/result.ts`
- **内容**: CSVヘッダーを翻訳キーで管理
- **翻訳追加**: `messages/ja.json`, `messages/en.json` に `csv` セクション追加

---

## 将来対応タスク（Backlog）

以下のタスクは現在の開発フェーズでは対応せず、将来の機能拡張として保留しています。

### 優先度：中（UX改善）

| タスク                          | 対象Phase | 説明                                                            |
| ------------------------------- | --------- | --------------------------------------------------------------- |
| 表示順序のドラッグ&ドロップ対応 | 2.6       | 投票対象の並び替えをドラッグ&ドロップで直感的に行えるようにする |

### 優先度：低（オプション機能）

| タスク             | 対象Phase | 説明                                       |
| ------------------ | --------- | ------------------------------------------ |
| 時系列データの表示 | 4.3       | 投票の時系列推移をグラフで表示する分析機能 |

### 優先度：低（本番環境後）

| タスク                 | 対象Phase | 説明                                           |
| ---------------------- | --------- | ---------------------------------------------- |
| Lighthouseスコアの改善 | 5.3       | 本番環境デプロイ後に実測し、必要に応じて最適化 |

### 対応方針

- 本番運用開始後、ユーザーフィードバックに基づき優先度を再評価
- 各タスクは独立して実装可能（既存機能への影響なし）
- 詳細な実装計画は着手時に策定

---

## 追加機能記録（2025年11月26日）

### Discord認証機能

#### 概要

Discord OAuth認証を追加し、Discordアカウントでの投票とサーバーゲート機能を実装。

#### 実装内容

**Phase A: 基本Discord認証**

- NextAuth.js v5にDiscordプロバイダーを追加
- サインインページにDiscordログインボタン追加
- イベント作成フォームに「Discordアカウント」認証オプション追加
- votingModeに "discord" を追加
- 翻訳ファイル更新（日本語/英語）

**Phase B: サーバーゲート機能**

- Prismaスキーマ拡張（discordGuildId, discordGuildName）
- Discord API連携モジュール作成（ギルドメンバーシップ確認）
- 認証フロー拡張（ゲート機能チェック）
- イベント作成フォームにサーバーID設定UI追加

#### 主要ファイル

- `src/auth.ts` - Discordプロバイダー追加
- `src/lib/auth/discord-guild.ts` - 新規作成（ギルド確認API）
- `src/lib/auth/voting-auth.ts` - ゲート機能チェック追加
- `src/lib/validations/event.ts` - スキーマ拡張
- `src/components/features/event-create-form.tsx` - UI更新
- `src/app/(auth)/auth/signin/page.tsx` - ログインボタン追加
- `prisma/schema.prisma` - Event モデル拡張
- `docs/DISCORD_AUTH_PLAN.md` - 詳細計画書

#### 環境変数

```env
DISCORD_CLIENT_ID=your_discord_client_id
DISCORD_CLIENT_SECRET=your_discord_client_secret
```
