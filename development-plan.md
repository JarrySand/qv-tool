# Quadratic Voting System 開発計画書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Quadratic Voting Tool (QV-Tool)

### 1.2 開発期間の目安
- **Phase 1 (基盤構築)**: 2-3週間
- **Phase 2 (認証・イベント管理)**: 3-4週間
- **Phase 3 (投票機能)**: 2-3週間
- **Phase 4 (集計・結果表示)**: 2週間
- **Phase 5 (品質向上・最適化)**: 2-3週間

**合計**: 約11-15週間（3-4ヶ月）

### 1.3 開発方針
- **段階的開発**: 各フェーズで動作する最小限の機能を実装し、段階的に拡張
- **テスト駆動**: 重要なロジックはテストを先に書き、実装を進める
- **ドキュメント重視**: 各フェーズでドキュメントを更新し、保守性を確保
- **OSS準備**: 最初からオープンソースとして公開することを前提に開発
- **モバイルファースト**: スマートフォンでの操作性を最優先に設計

### 1.4 進捗管理ルール
> **重要**: タスク完了時は必ず本ドキュメントのチェックボックスを `[x]` に更新すること。
> これにより、プロジェクトの進捗状況を常に正確に把握できる。

## 2. 開発フェーズ詳細

### Phase 1: プロジェクト基盤構築

#### 目標
開発環境のセットアップと基本的なプロジェクト構造の確立

#### タスク一覧

**1.1 プロジェクト初期化**
- [x] Next.js 15+ プロジェクトの作成（TypeScript）
- [x] 基本的なディレクトリ構造の作成
- [x] Git リポジトリの初期化と `.gitignore` 設定
- [x] README.md の作成

**1.2 開発環境のセットアップ**
- [x] Docker Compose の設定（PostgreSQL含む）
- [x] DevContainer 設定（VS Code）
- [x] 環境変数管理（`.env.example` の作成）
- [x] 開発用スクリプトの整備

**1.3 スタイリング基盤**
- [x] Tailwind CSS の導入と設定
- [x] Shadcn/ui の初期化
- [x] テーマカラーの設定（Primary: 黒 #000000、Secondary: イエロー #EDFF38）
- [x] 基本的なUIコンポーネントのセットアップ（Button, Input, Card等）
- [x] レスポンシブデザインの基本設定（モバイルファースト）※Tailwind CSSデフォルト設定済み、具体的実装はPhase 3で実施

**1.4 バリデーション基盤**
- [x] Zod の導入
- [x] 基本的なバリデーションスキーマの作成（共通パターン）

**1.5 データベース基盤**
- [x] PostgreSQL のセットアップ（Docker）
- [x] Prisma の導入と初期設定
- [x] スキーマ定義（要件定義書に基づく + Event.adminToken の追加）
- [x] マイグレーションの実行
- [x] Prisma Studio の動作確認

**1.6 開発ツールの設定**
- [x] ESLint の設定（Next.js推奨設定）
- [x] Prettier の設定
- [x] TypeScript の厳格な設定
- [x] Husky + lint-staged の設定
- [x] Vitest の初期設定
- [x] Playwright の初期設定

**1.7 CI/CD基盤**
- [x] GitHub Actions のワークフロー作成
  - Lint チェック
  - Type チェック
  - 単体テスト実行
  - ビルドチェック

#### 成果物
- 動作するNext.jsアプリケーション（Hello Worldレベル）
- データベース接続確認済み
- 開発環境がDockerで一発起動可能
- CI/CDパイプラインが動作

---

### Phase 2: 認証システムとイベント管理基盤

#### 目標
投票者向け認証機能の実装とイベント管理（認証不要）の基本機能を構築

#### タスク一覧

**2.1 認証基盤の構築（投票者向け）**
- [ ] NextAuth.js (v5) の導入と設定
- [ ] セッション管理の実装
- [ ] 認証ミドルウェアの作成（投票者認証用）
- [ ] 管理用トークン検証ミドルウェアの作成（イベント管理用）

**2.2 Google認証の実装**
- [ ] Google OAuth 2.0 の設定
- [ ] 認証フローの実装
- [ ] コールバック処理の実装
- [ ] エラーハンドリング

**2.3 LINE認証の実装**
- [ ] LINE OpenID Connect の設定
- [ ] 認証フローの実装
- [ ] コールバック処理の実装
- [ ] エラーハンドリング

**2.4 個別投票認証の実装**
- [ ] AccessToken モデルの活用
- [ ] ユニークURL生成ロジック
- [ ] トークン検証ミドルウェア
- [ ] 使用済みトークンの管理

**2.5 イベント管理機能（基本）**
- [ ] イベント作成フォームのUI実装（認証不要）
- [ ] イベント作成のServer Action実装
- [ ] 管理用トークン（adminToken）の自動生成
- [ ] Event.slug の自動生成と手動設定オプション（URL用の短縮識別子）
- [ ] バリデーション（Zod）の実装
- [ ] イベント作成完了画面（管理用URLの表示・コピー機能）
- [ ] 管理用URLの保管に関する注意喚起UI（一度閉じると再表示不可の警告）
- [ ] イベント管理ページ（adminTokenによるアクセス制御）
- [ ] イベント編集機能の実装
- [ ] 投票開始後の編集制限ロジック（投票対象・クレジット数の変更不可）

**2.6 投票対象管理機能**
- [ ] Subject作成・編集・削除のUI
- [ ] Server Actions実装
- [ ] 画像アップロード機能（Vercel Blob または外部URLを検討）
- [ ] 表示順序の管理（ドラッグ&ドロップ対応を検討）

**2.7 個別投票用トークン管理**
- [ ] トークン一括生成機能
- [ ] CSVエクスポート機能
- [ ] トークン使用状況の表示

#### 成果物
- 3種類の投票者認証方式が動作（個別URL/Google/LINE）
- 誰でもイベント作成可能（認証不要）
- 管理用トークンによるイベント編集が可能
- 投票対象の追加・編集が可能
- 個別投票用トークンの生成・配布が可能

---

### Phase 3: 投票機能の実装

#### 目標
投票者向けの投票インターフェースと投票処理を実装

#### タスク一覧

**3.1 イベント公開ページ**
- [ ] イベントトップページの実装
- [ ] イベント情報の表示（タイトル、説明、期間）
- [ ] ステータス表示（開催中/終了）
- [ ] 認証状態に応じたナビゲーション

**3.2 QV計算ユーティリティの実装**
- [ ] クレジット消費計算関数（票数² = コスト）
- [ ] 残りクレジット計算関数
- [ ] 投票可能票数の上限計算関数
- [ ] ユーティリティ関数の単体テスト作成

**3.3 投票インターフェース**
- [ ] 投票対象一覧の表示
- [ ] 各対象の詳細情報表示（画像、説明、URL）
- [ ] 「+」「-」ボタンの実装
- [ ] リアルタイムクレジット計算の実装（QVユーティリティを使用）
- [ ] 残りクレジット表示
- [ ] 投票プレビュー機能

**3.4 バリデーション実装**
- [ ] クライアントサイドバリデーション
  - クレジット超過の防止
  - 期間外投票のブロック
  - 必須項目チェック
- [ ] サーバーサイドバリデーション
  - 二重投票の防止
  - トークン/ユーザー認証の確認
  - データ整合性チェック

**3.5 投票送信処理**
- [ ] 投票データのServer Action実装
- [ ] Vote/VoteDetailモデルへの保存
- [ ] トランザクション処理
- [ ] エラーハンドリング
- [ ] 投票完了画面の実装

**3.6 再投票機能（必須）**
- [ ] 投票内容の編集機能（投票期間内のみ）
- [ ] 既存投票の更新処理（VoteDetailの上書き）
- [ ] 投票済み状態の表示と編集ボタン

**3.7 投票機能のテスト**
- [ ] E2Eテスト（投票フロー全体）

#### 成果物
- 投票者が投票できる完全なフロー
- リアルタイムクレジット計算
- 適切なバリデーション
- 投票データの正確な保存

---

### Phase 4: 集計・結果表示機能

#### 目標
投票結果の集計と可視化機能を実装

#### タスク一覧

**4.1 リアルタイム結果表示**
- [ ] 結果表示ページの実装
- [ ] 各投票対象の得票数表示
- [ ] グラフ表示（棒グラフ/円グラフ）
- [ ] リアルタイム更新機能（必要に応じて）

**4.2 統計情報の実装**
- [ ] 総参加者数の集計
- [ ] 総消費クレジットの集計
- [ ] 平均投票数の計算
- [ ] その他の統計指標

**4.3 結果詳細分析**
- [ ] 詳細分析ページの実装
- [ ] 投票分布の可視化
- [ ] 時系列データの表示（オプション）

**4.4 CSVエクスポート機能**
- [ ] ローデータ（個別投票データ）のエクスポート
- [ ] 集計データのエクスポート
- [ ] ダウンロード機能の実装

**4.5 結果表示の最適化**
- [ ] 投票ページから結果ページへのナビゲーション
- [ ] 結果ページの自動更新（ポーリングまたはリアルタイム）
- [ ] ※結果は常時リアルタイム公開（設計決定事項 4.3 参照）

#### 成果物
- 投票結果の正確な集計と常時リアルタイム表示
- 統計情報の提供
- CSVエクスポート機能
- 視覚的に分かりやすい結果表示

---

### Phase 5: 品質向上・最適化・国際化

#### 目標
アプリケーションの品質向上、パフォーマンス最適化、国際化対応

#### タスク一覧

**5.1 国際化（i18n）**
- [ ] next-intl の導入と設定
- [ ] 日本語リソースファイルの作成
- [ ] 英語リソースファイルの作成
- [ ] 言語切り替えUIの実装
- [ ] 日付・数値のロケール対応

**5.2 アクセシビリティ（a11y）**
- [ ] WCAG 2.1 Level AA 準拠の確認
- [ ] スクリーンリーダー対応の確認
- [ ] キーボード操作の完全対応
- [ ] コントラスト比の確認
- [ ] ARIA属性の適切な設定

**5.3 パフォーマンス最適化**
- [ ] 画像最適化（Next.js Image）
- [ ] コード分割の最適化
- [ ] データベースクエリの最適化
- [ ] キャッシュ戦略の実装
- [ ] Lighthouse スコアの改善

**5.4 エラーハンドリング強化**
- [ ] グローバルエラーバウンダリの実装
- [ ] ユーザーフレンドリーなエラーメッセージ
- [ ] エラーロギングの実装
- [ ] 404/500ページの実装

**5.5 セキュリティ強化**
- [ ] SQLインジェクション対策の確認
- [ ] XSS対策の確認
- [ ] CSRF対策の確認
- [ ] レート制限の実装
- [ ] セキュリティヘッダーの設定

**5.6 テストカバレッジ向上**
- [ ] 単体テストの追加（カバレッジ80%以上を目標）
- [ ] E2Eテストの追加（主要フロー）
- [ ] 統合テストの追加

**5.7 ドキュメント整備**
- [ ] API ドキュメントの作成
- [ ] コンポーネントドキュメント（Storybook検討）
- [ ] デプロイ手順書の作成
- [ ] コントリビューションガイドの作成
- [ ] ユーザーマニュアルの作成

**5.8 デプロイ準備**
- [ ] Vercel（または他のホスティング）へのデプロイ設定
- [ ] 本番環境の環境変数設定
- [ ] データベースマイグレーション戦略
- [ ] ドメイン設定（必要に応じて）
- [ ] SSL証明書の設定

#### 成果物
- 多言語対応アプリケーション
- アクセシビリティ準拠
- 高パフォーマンス
- セキュアなアプリケーション
- 充実したドキュメント

---

## 3. 技術的考慮事項

### 3.1 データベース設計の注意点
- **トランザクション**: 投票送信時は複数テーブルへの書き込みが必要なため、Prismaのトランザクション機能を活用
- **インデックス**: `eventId`, `userId`, `accessTokenId` など、検索頻度の高いカラムにインデックスを設定
- **カスケード削除**: Event削除時は関連するSubject、Vote、AccessTokenも削除されるよう設定
- **スキーマ活用**: 要件定義書のスキーマで定義済みの以下を活用
  - `Event.adminToken`: イベント管理用トークン（認証不要のため、このトークンで編集権限を制御）
  - `VoteDetail.amount`: 0以上の整数制約（マイナス投票なし）

### 3.2 認証の実装方針
- **主催者**: 認証不要。イベント作成時に管理用トークン（adminToken）を発行し、URLで編集権限を制御
- **投票者（個別投票）**: URLパラメータのトークンで認証（ログイン操作不要）
- **投票者（Social Auth）**: NextAuth.jsの標準機能を活用（Google/LINE）
- **認証ミドルウェア**: 投票者認証と管理用トークン検証の2種類を実装

### 3.3 パフォーマンス最適化
- **Server Components**: 初期表示はRSCを最大限活用
- **データフェッチング**: 必要最小限のデータのみ取得
- **リアルタイム更新**: 投票結果のリアルタイム更新は必要に応じて実装（WebSocket/Server-Sent Events）

### 3.4 セキュリティ対策
- **入力検証**: Zodによる厳格なバリデーション
- **認証チェック**: すべての保護されたルートで認証を確認
- **レート制限**: 投票送信など重要な操作にレート制限を実装

### 3.5 認証とユーザーモデルの整理
- **Userモデル**: Social Auth（Google/LINE）で認証した投票者のみを格納
- **主催者**: Userモデルを使用しない。adminTokenによるステートレスな権限管理
- **個別投票者**: AccessTokenモデルで管理し、Userモデルには格納しない
- **認証フローの分離**:
  - 主催者: イベント作成 → adminToken発行 → URLで編集権限を制御
  - 投票者(Social): NextAuth.jsによるOAuth認証 → Userモデルに格納
  - 投票者(個別): AccessToken付きURLでアクセス → ログイン操作不要

## 4. リスク管理

### 4.1 技術的リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| NextAuth.js v5のドキュメント不足 | 中 | コミュニティやGitHub Issuesを参照、必要に応じてv4から移行 |
| リアルタイム更新の実装複雑性 | 中 | 初期はポーリングで実装、後で最適化 |
| パフォーマンス問題 | 高 | 早期からパフォーマンステストを実施、必要に応じて最適化 |
| 管理用トークンの漏洩 | 高 | adminTokenが漏洩するとイベントが改ざんされる。トークンの安全な管理方法をユーザーに案内 |
| 画像ストレージの選定 | 中 | Vercel Blob を第一候補とし、コスト・容量を監視 |

### 4.2 スケジュールリスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| 機能追加による遅延 | 中 | MVP（最小限の機能）を優先、追加機能は後回し |
| バグ修正の時間超過 | 高 | テストを早期から実装し、バグを早期発見 |

### 4.3 設計決定事項
以下の項目は決定済み：

1. **主催者の認証方式**: 認証不要。誰でも投票イベントを作成可能
2. **投票者の再投票**: 投票期間内であればいつでも変更可能（必須機能）
3. **マイナス投票**: なし（0以上の票数のみ許可）
4. **結果公開タイミング**: 常時リアルタイムで公開（設定機能は不要）

## 5. 要件定義書との対応表

| 要件ID | 機能名 | 対応Phase | 備考 |
|--------|--------|-----------|------|
| AUTH-01 | 個別投票 | Phase 2 (2.4) | AccessToken使用 |
| AUTH-02 | Google認証 | Phase 2 (2.2) | NextAuth.js |
| AUTH-03 | LINE認証 | Phase 2 (2.3) | NextAuth.js |
| AUTH-04 | セッション管理 | Phase 2 (2.1) | NextAuth.js |
| AUTH-05 | 主催者認証 | Phase 2 (2.5) | adminTokenによる権限管理 |
| EVENT-01 | イベント作成 | Phase 2 (2.5) | - |
| EVENT-02 | 投票対象管理 | Phase 2 (2.6) | - |
| EVENT-03 | 参加者管理 | Phase 2 (2.7) | CSVダウンロード含む |
| EVENT-04 | イベント編集 | Phase 2 (2.5) | 編集制限ロジック含む |
| VOTE-01 | イベントトップ表示 | Phase 3 (3.1) | - |
| VOTE-02 | 投票インターフェース | Phase 3 (3.3) | - |
| VOTE-03 | バリデーション | Phase 3 (3.4) | クライアント/サーバー両方 |
| VOTE-04 | 投票送信 | Phase 3 (3.5) | - |
| VOTE-05 | 再投票 | Phase 3 (3.6) | 投票期間内のみ変更可能 |
| RES-01 | リアルタイム結果表示 | Phase 4 (4.1) | - |
| RES-02 | 結果詳細分析 | Phase 4 (4.2, 4.3) | - |
| RES-03 | CSVエクスポート | Phase 4 (4.4) | - |

## 6. マイルストーン

### Milestone 1: 基盤完成（Phase 1完了）
- 開発環境が整い、基本的なアプリケーションが動作

### Milestone 2: 認証・イベント管理完成（Phase 2完了）
- イベント作成と管理が可能

### Milestone 3: MVP完成（Phase 3完了）
- 基本的な投票機能が動作する最小限の製品

### Milestone 4: 完全版完成（Phase 4完了）
- すべての主要機能が実装済み

### Milestone 5: リリース準備完了（Phase 5完了）
- 本番環境にデプロイ可能な状態

## 7. 次のステップ

1. **Phase 1の開始**: プロジェクト初期化から着手
2. **定期的なレビュー**: 各フェーズ終了時に進捗を確認し、必要に応じて計画を調整
3. **コミュニティフィードバック**: 可能であれば、早期からOSSとして公開し、フィードバックを収集

## 8. 参考リソース

- [Next.js Documentation](https://nextjs.org/docs)
- [Prisma Documentation](https://www.prisma.io/docs)
- [Auth.js (NextAuth.js v5) Documentation](https://authjs.dev/)
- [Shadcn/ui Documentation](https://ui.shadcn.com/)
- [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)

---

**作成日**: 2025年11月
**最終更新**: 2025年11月26日
**バージョン**: 1.5

---

## Phase 1 完了記録
- **完了日**: 2025年11月26日
- **引き継ぎ資料**: `HANDOVER.md` 参照

